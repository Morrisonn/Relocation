{% extends 'main/hr/base.html' %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
{% load bootstrap4 %}
{% bootstrap_css %}
{% bootstrap_javascript %}
{% block userPage %}

<div class="template-div" style="width: 100%;
display: flex;
flex-direction: column;">

    <style>
        #employee_profile{
            text-align: center;
            font-size: 24px;
            font-style: bold !important;
        }
        h1 {
            position: absolute;
            top: 40%;
            left: 220;
            width: 100%;
        }
        .content-div{
        width: 1536px;
        height: 633px;
    
        .nav-item{
          margin-left: 100px;
            margin-right: 100px;
            margin-top: 15px;
            pointer-events: none;
        }
        .nav-link {
          border-radius: 50%;
          width: 45px;
          height: 45px;
          line-height: 30px;
          text-align: center;
        }
        .container{
          width: 2000px;
        }
        .progress {
        position: relative;
        }
        .status-p{
          width: 80%;
        }
    }
    </style>
    
    <div class="container">
		<div class="row">
		  <div class="col-md-12" >
			<ul class="nav nav-pills mb-3 justify-content-center" id="pills-tab" role="tablist">
			  <li class="nav-item" role="presentation">
				<a class="nav-link" id="pills-step1-tab" data-toggle="pill" href="#pills-step1" role="tab" aria-controls="pills-step1" aria-selected="true">1</a>
			  </li>
			  <li class="nav-item" role="presentation">
				<a class="nav-link" id="pills-step2-tab" data-toggle="pill" href="#pills-step2" role="tab" aria-controls="pills-step2" aria-selected="false">2</a>
			  </li>
			  <li class="nav-item" role="presentation">
				<a class="nav-link" id="pills-step3-tab" data-toggle="pill" href="#pills-step3" role="tab" aria-controls="pills-step3" aria-selected="false">3</a>
			  </li>
        <li class="nav-item" role="presentation">
          <a class="nav-link" id="pills-step4-tab" data-toggle="pill" href="#pills-step3" role="tab" aria-controls="pills-step3" aria-selected="false">4</a>
        </li>
			</ul>
			<div class="progress mb-3">
			  <div class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
			</div>
			<div class="tab-content" id="pills-tabContent">
			  <div class="tab-pane fade show active" id="pills-step1" role="tabpanel" aria-labelledby="pills-step1-tab">
				
			  </div>
			  <div class="tab-pane fade" id="pills-step2" role="tabpanel" aria-labelledby="pills-step2-tab">
				
			  </div>
			  <div class="tab-pane fade" id="pills-step3" role="tabpanel" aria-labelledby="pills-step3-tab">
				
			  </div>
			</div>
		  </div>
		</div>
    <div>
      <p class="status-p">1. Заявка отправлена</p>
      <p class="status-p">2. Назначено собеседование</p>
      <p class="status-p">3. Собеседование пройдено. Ожидание документов</p>
      <p class="status-p">4. Релокация завершена</p>

      <button style="position: absolute; top:160px; left: 1123px; width: 200px;" class="btn btn-primary" onclick="window.location.href='{% url 'hr_userProfile' userId=userId %}'">Профиль сотрудника</button>

    <script>
		document.addEventListener("DOMContentLoaded", function(event) {
		var status = "{{ status }}";
		var progressBar = document.querySelector(".progress-bar");
		
		if (status == "first") {
			progressBar.style.width = "25%";
			progressBar.setAttribute("aria-valuenow", "25" );
			document.querySelector("#pills-step1-tab").classList.add("active");
		} else if (status == "second") {
			progressBar.style.width = "50%";
			progressBar.setAttribute("aria-valuenow", "50");
			document.querySelector("#pills-step2-tab").classList.add("active");
		} else if (status == "third") {
			progressBar.style.width = "75%";
			progressBar.setAttribute("aria-valuenow", "75");
			document.querySelector("#pills-step3-tab").classList.add("active");
		}
    else if (status == "fourth") {
			progressBar.style.width = "100%";
			progressBar.setAttribute("aria-valuenow", "100");
			document.querySelector("#pills-step4-tab").classList.add("active");
		}
		});
	  </script>
        <div style="position: absolute; top:220px; left: 210px;" >
          {% if user_application.status == "first" or user_application.status == "second" %}
            <script src="https://meet.jit.si/external_api.js"></script>
            <div id="jitsi-container" style="margin-top: 30px; margin-right: 30px;"></div>
            <script>
              const domain = 'meet.jit.si';
              const userName = 'София';
              const options = {
                roomName: generateUniqueRoomName(),
                width: 800,
                height: 420,
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: {
                  defaultLanguage: 'ru',
                },
                interfaceConfigOverwrite: {
                  DEFAULT_LANGUAGE: 'ru',
                  LANG_DETECTION: true,
                  LANGUAGES: {
                    ru: 'Русский',
                  },
                },
              };

              const api = new JitsiMeetExternalAPI(domain, options);
              // Функция для генерации уникального идентификатора встречи
              function generateUniqueRoomName() {
                // В данном примере используется текущая дата и случайное число
                const firstName = "София";
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 10000);
                // return `meeting-${timestamp}-${random}`;
                return `${firstName}-meeting-${timestamp}-${random}`
              }
              // const meetingURL = api.getMeetingURL();
              // alert(`URL встречи: ${meetingURL}`);

              const exitButton = document.querySelector('#exit-button');
              exitButton.addEventListener('click', () => {
                api.dispose();
              });
              // console.log('URL встречи:', meetingURL);

              api.addEventListener('ready', () => {
                // Получение URL встречи
                const meetingURL = api.getMeetingURL();
                console.log('URL встречи:', meetingURL);

                const meetingLink = document.createElement('a');
                meetingLink.href = meetingURL;
                meetingLink.textContent = 'Ссылка на встречу';
                document.body.appendChild(meetingLink);
              });
            </script>
            <!-- <script>
              const domain = 'meet.jit.si';
              const options = {
                roomName: 'your-room-name',
                width: 800,
                height: 600,
                parentNode: document.querySelector('#jitsi-container'),
              };
              const api = new JitsiMeetExternalAPI(domain, options);
            </script> -->
            {% if user_application.status == "first" %}
            <style>
              input{
                margin-top: 10px;
                width: 180px
              }
              label{
                width: 300px;
              }
            </style>
            <div style="position: absolute; top:15px; left: 840px;">
              <form method="post" class="first_form" style="text-align: center; margin-top: 10px;">
                {% csrf_token %}
                {{ form.as_p }}
                <div class="form-group">
                  <button type="submit" class="btn btn-primary" style="width: 410px; margin-top: 10px;">Сохранить</button>
                </div>
              </form>
            </div>  
            {% elif user_application.status == "second" %}
            <div style="position: absolute; top:20px; left: 820px;">
              <form method="post" class="first_form" style="text-align: center; margin-top: 10px;">
                {% csrf_token %}
                {% for field in form %}
                  {{ field }}
                {% endfor %}
                <div class="form-group">
                  <button type="submit" class="btn btn-primary" style="width: 345px; margin-top: 10px;">Завершить собеседование</button>
                </div>
              </form>
            </div>
            {% endif %}
          {% elif user_application.status == "third" or user_application.status == "fourth" %}
              <div style="position: absolute; top:50px; left: 850px;">
                <div class="container">
                  <div class="row">
                    <div class="col-md-12" style="width: 250px;">
                      <h4 style="margin-bottom: 5px; margin-top: 30px; text-align: xenter;">Ваши заметки по собеседованию:</h4>
                      <div class="card" style="width: 250px; height: 350px;">
                        <div class="card-body">
                          <p class="card-text">{{notes.0.notes}}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div style="position: absolute; top:50px; left: 450px; width: 400px;">
                <div class="container">
                  <div class="row">
                    <div class="col-md-12" style="width: 400px;">
                      <h4 style="margin-bottom: 5px; margin-top: 30px; margin-left: 0px;">Документы:</h4>
                      <div class="card" style="width: 350px; height: 350px;">
                        <div class="card-body">
                          {% for obj in documents %}
                            <p class="card-text" style="margin-bottom: 5px;">
                              <a href="{{ obj.file }}" download>{{ obj.title }}</a>
                            </p>
                          {% endfor %}
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              {% if user_application.status == "third" %}
                <form method="post">
                  {% csrf_token %}
                  <button style="position:absolute; left: 913px; width: 200px;" class="btn btn-primary" type="submit" name="btn-fourth">Завершить релокацию</button>
                </form>
                <h1 style="position: absolute; top:70px; left: 0px; margin-top: 10px; width: 300px !important;">Список необходимых документов:</h1>
                <div style="position: absolute; top:70px; left: 0px; margin-top: 30px;">
                  <style>
                    input{
                      width: 410px;
                    }
                    button{
                      margin-top: 10px;
                      margin-bottom: 0px;
                    }
                  </style>
                  <form method="post" class="checklist-form" style="text-align: center; ">
                    {% csrf_token %}
                    {{ formset.management_form }}
                    <div id="input-container">
                      {% for form in formset %}
                        <!-- {{ form.as_p }} -->
                      {% endfor %}
                    </div>
                    <div class="form-group" style="margin-bottom: 0px;">
                      <button type="button" onclick="removeInputField()" class="btn btn-danger btn-sm" style="margin-right: 5px; width: 200px; padding: 0;"><i class="fas fa-minus">Удалить</i></button>
                      <button type="button" onclick="addInputField()" class="btn btn-success btn-sm" style="width: 200px; padding: 0;"><i class="fas fa-plus">Добавить</i></button>
                    </div>              
                    <div class="form-group" style="margin-bottom: 0px;">
                      <button type="submit" class="btn btn-primary" style="width: 410px;">Сохранить</button>
                    </div>
                  </form>
                </div>

                <script>
                  var formsetPrefix = "{{ formset.prefix }}";
                  var totalFormsInput = document.querySelector('#id_' + formsetPrefix + '-TOTAL_FORMS');

                  function addInputField() {
                    var container = document.getElementById("input-container");
                  var formIndex = parseInt(totalFormsInput.value);

                  var fieldHtml = `
                    <div class="form-row" style="margin-left: 1px; height:30px">
                      <div class="form-group">
                        <input type="text" name="${formsetPrefix}-${formIndex}-name" id="id_${formsetPrefix}-${formIndex}-name">
                      </div>
                    </div>
                  `;

                  container.insertAdjacentHTML('beforeend', fieldHtml);
                  totalFormsInput.value = formIndex + 1;

                  // Сохранение значения в локальном хранилище браузера
                  var addedField = container.querySelector(`#id_${formsetPrefix}-${formIndex}-field`);
                  addedField.addEventListener('input', function() {
                    localStorage.setItem(this.name, this.value);
                  });

                  // Установка сохраненного значения (если есть) в поле формы
                  var savedValue = localStorage.getItem(`${formsetPrefix}-${formIndex}-field`);
                  if (savedValue) {
                    addedField.value = savedValue;
                  }
                }
                function removeInputField() {
                  var container = document.getElementById("input-container");
                  var formIndex = parseInt(totalFormsInput.value) - 1;

                  if (formIndex >= 0) {
                    var lastField = container.lastElementChild;
                    container.removeChild(lastField);
                    totalFormsInput.value = formIndex;
                  }
                }
                </script>  
              {% endif %}  
            
          {% else %}
              <p>Статус неизвестен</p>
          {% endif %}
        </div>
        
</div>
{% endblock %}